#NoEnv  ; Recommended for performance and compatibility with future AutoHotkey releases.
; #Warn  ; Enable warnings to assist with detecting common errors.
SendMode Input  ; Recommended for new scripts due to its superior speed and reliability.
SetWorkingDir %A_ScriptDir%  ; Ensures a consistent starting directory.
StringCaseSense, Locale

{ ; СТАРТ

Script_Version := 1.1

Center_X := A_ScreenWidth/2
Center_Y := A_ScreenHeight/2

Updated_Version := URLDownloadToVar("https://raw.githubusercontent.com/Oakenlix/IRevive_Plenka/main/Update")

RegexMatch(Updated_Version, "\w.\w", Updated_Version)

If (Script_Version != Updated_Version)
	If Updated_Version
	{
		Updated_text := URLDownloadToVar("https://raw.githubusercontent.com/Oakenlix/IRevive_Plenka/main/Main")
		FileCreateDir, %A_ScriptDir%\Backups
		FileMove, %A_ScriptName%, %A_ScriptDir%\Backups\%A_Hour%%A_Min%-%A_DD%%A_MM%.ahk
		FileAppend, %Updated_text%, %A_ScriptName%
		Run, %A_ScriptName%
		ExitApp
	}
	
URLDownloadToVar(url) {
 WebRequest := ComObjCreate("WinHttp.WinHttpRequest.5.1")
 WebRequest.Open("GET", url)
 WebRequest.Send()
 Return, WebRequest.ResponseText
}
	
; ####################################### Загрузка настроек

If !FileExist("Settings.txt")
FileAppend,
(
%A_Tab%Имя
-
-
-
-





	OZON Все галочки Х
	OZON Все галочки Y
	OZON Этикетки X
	OZON Этикетки Y
	OZON Поиск X
	OZON Поиск Y




	YANDEX Поиск X
	YANDEX Поиск Y
	YANDEX Заказ X
	YANDEX Заказ Y
	YANDEX Креатив Х
	YANDEX Креатив Y
	YANDEX Ярлык Х
	YANDEX Ярлык Y


	WB Все галочки X
	WB Все галочки Y
	WB Этикетки X
	WB Этикетки Y
	WB 3 точки X
	WB 3 точки Y
	WB Первая поставка X
	WB Первая поставка Y
), Settings.txt

LoadSettings()

LoadSettings()
{
	global Setting := []
	Loop, read, Settings.txt
	{
		StringSplit, Result, A_LoopReadLine, %A_Tab%
		Setting[A_Index] := Result1
	}
}


} ; СТАРТ

:?:/я::
SendInput % A_DD "." A_Mon A_Space Setting[1]
return

!0::
sleep 100
global OrderLine := []
Current_Line :=
SendInput ^{vk43}
sleep 200

Loop, parse, clipboard, `n, `r ; Загружаем массив строк
	Amount := OrderLine.Push(A_LoopField)

StringSplit, Result, % OrderLine[1], %A_Tab% ; Проверяем маркетплейс по первой строке
If (Result0 == 3)
	MARKETPLACE := "WB"
If (Result0 == 4)
	If RegexMatch(Result1, "[0-9]{9}", Result)
		MARKETPLACE := "YANDEX"
If (Result0 == 4)
	If RegexMatch(Result1, "\d+-\d+-\d+", Result)
		MARKETPLACE := "OZON"
SendInput {Alt up}
return

!1::
sleep 100
If (MARKETPLACE == "OZON")
	Ozon1()
If (MARKETPLACE == "WB")
	WB1()
If (MARKETPLACE == "YANDEX")
	YANDEX1()
SendInput {Alt up}
return

!2::
sleep 100
If (MARKETPLACE == "WB")
	WB2()
If (MARKETPLACE == "OZON")
	Ozon2()
SendInput {Alt up}
return

!5:: ; Перемещение поставки WB
sleep 100
WinGetActiveTitle, Title
If InStr(Title, "Поставка")
{
	InputBox, DeliveryA, Поставки, Сколько заказов переместить?, , 250, 130
	DeliveryA -= 1
	sleep 200
	Click %	Setting[35] "," Setting[36] ; 3 точки у верхнего заказа
	SendInput {tab 2}{enter} ; Выбрать перенос в другую поставку
	sleep 200
	Click %	Setting[37] "," Setting[38]  ; Выбрать первую поставку
	InputBox, DeliveryN, Поставки, Какая поставка по счету?, , 250, 130
	DeliveryN -= 1
	sleep 200
	loop %DeliveryN% ; Пролистать до нужной поставки
		SendInput {down}
	sleep 100
	SendInput {tab}{enter}
	sleep 1100
	loop %DeliveryA%
	{
		If GetKeyState(Esc)
			break
		Click %	Setting[35] "," Setting[36] ; 3 точки у верхнего заказа
		SendInput {tab 2}{enter}
		sleep 200
		Click %	Setting[37] "," Setting[38]  ; Выбрать первую поставку
		sleep 100
		loop %DeliveryN% ; Пролистать до нужной поставки
			SendInput {down}
		sleep 100
		SendInput {tab}{enter}
		sleep 1100
	}	
}
SendInput {Alt up}
return

!6::
Click, %Center_X%, 100
sleep 100
SendInput {tab4}{enter}
return

{ ; ========================================================= OZON
Ozon1()
{
global

loop 10 ; Чистка вкладок
{
	WinGetActiveTitle, Title
	If InStr(Title, "Ozon: Торговая площадка")
	{
		SendInput ^{PgUp} ; Предыдущая вкладка
		break
	}
	sleep 50
	If InStr(Title, "в интернет-магазине OZON") or If InStr(Title, "posting-label-") or If InStr(Title, "ticket-")
	{
		SendInput ^{vk57}		 ; ctrl+W
		SendInput ^{PgUp}		 ; Предыдущая вкладка
		sleep 100
	}

	else If !InStr(Title, "Ozon: Торговая площадка")
	{
		SendInput ^{PgUp}		 ; Предыдущая вкладка
	}
	sleep 50
}
sleep 100

O_Start:
sleep 100
Current_Line += 1

If !OrderLine[Current_Line]
{
MsgBox, 262144, OZON, Конец списка
return
}

OrderPart := StrSplit(OrderLine[Current_Line], A_Tab)

Clipboard := OrderPart[1]

If !OrderPart[1]
	Goto, O_Start


If InStr(Title, "Ozon: Торговая площадка")
{
	SendInput ^{vk46}{esc} ; CTRL+F - ESC
	sleep 100
	SendInput {Home}
	sleep 150
	Click %	Setting[11] "," Setting[12] ; все галочки
	sleep 100
	Click %	Setting[11] "," Setting[12] ; все галочки
	sleep 300
	SendInput ^{vk46} ; CTRL+F
	sleep 300
	SendInput ^{vk56} ; CTRL+V

			
	If (OrderPart[3] > 1)		; Проверка количества
		MsgBox, 262144, OZON, % "КОЛИЧЕСТВО: " OrderPart[3] ; Напоминание о количестве
		
}
} ; OZON1

Ozon2()
{
global

WinMinimize, ahk_exe AutoHotkeyU64.exe
sleep 100
SendInput ^{vk46}{esc} ; CTRL+F - ESC
sleep 100
SendInput {Home}
sleep 150
SendInput {Home}
sleep 150
Click %	Setting[13] "," Setting[14] ; Распечатать этикетки

Loop 20 ; Цикл проверки загрузки ярлыка
{
WinGetActiveTitle, Title
If InStr(Title, "posting-label-") or InStr(Title, "ticket-")
	{
	sleep 1000
	SendInput ^{vk50} ; ctrl+P
	sleep 2000
	SendInput {enter}
	sleep 800
	break
	}
sleep 250
}

loop 10 ; Чистка вкладок
{
	WinGetActiveTitle, Title
	If InStr(Title, "Ozon: Торговая площадка")
	{
		If WinActive("ahk_exe browser.exe")
			SendInput ^{PGDN}
		break
	}
	
	sleep 50
	If InStr(Title, "купить в интернет-магазине OZON") or InStr(Title, "posting-label-") or InStr(Title, "ticket-") ; Закрываем вкладки с ярлыком и креативом
	{
		SendInput ^{vk57}		 ; ctrl+W
		If WinActive("ahk_exe chrome.exe")
			SendInput ^{PGUP}		 ; Предыдущая вкладка
		sleep 100
	}

	else If !InStr(Title, "Ozon: Торговая площадка")
	{
		SendInput ^{PGUP}		 ; Предыдущая вкладка
	}
	sleep 50
}
Clipboard := OrderPart[4]
sleep 300
SendInput {home 2}
sleep 200
Click %	Setting[15] "," Setting[16] ; Поиск в каталоге
SendInput ^{vk41} ; CTRL+A
sleep 100
Sendinput ^{vk56} ; CTRL+V
sleep 300
Clipboard := OrderPart[2]
SendInput ^{vk46} ; CTRL+F
sleep 300
Sendinput ^{vk56} ; CTRL+V
loop 5
{
sleep 300
SendInput {enter}
}
WinActivate, ahk_exe AutoHotkeyU64.exe
Clipboard := OrderPart[4]
} ; OZON2

} ; ========================================================= КОНЕЦ OZON

Yandex1() ;========================================================= YANDEX
{
global

loop 10 ; Чистка вкладок
{
	WinGetActiveTitle, Title
	If InStr(Title, "Заказы и отгрузки")
	{
		break
	}
	If InStr(Title, "на Яндекс Маркете") or InStr(Title, "Страница товара") or RegexMatch(Title, "\w{8}-\w{4}-\w{4}-\w{4}-\w{12}", Result)
	{
		SendInput ^{vk57}		 ; ctrl+W
		SendInput ^{PgUp}		 ; Предыдущая вкладка
		sleep 100
	}

	else If !InStr(Title, "Заказы и отгрузки")
	{
		SendInput ^{PgUp}		 ; Предыдущая вкладка
	}
	sleep 100
}

Y_Start:
sleep 100
Current_Line += 1

If !OrderLine[Current_Line]
{
SendInput {esc}
MsgBox, 262144, YANDEX, Конец списка
return
}

OrderPart := StrSplit(OrderLine[Current_Line], A_Tab)

If !OrderPart[1]
	Goto, Y_Start

sleep 100
WinGetActiveTitle, Title
If InStr(Title, "Заказы и отгрузки")
{	
	SendInput {esc}
	sleep 400
	SendInput {tab}{home}
	sleep 200
	Click %	Setting[21] "," Setting[22]		; Окно поиска
	sleep 300
	Clipboard := OrderPart[1]
	Sendinput ^{vk41}^{vk56}
	sleep 1500
	Click %	Setting[23] "," Setting[24]				; Клик на номер заказа
	sleep 1500
	Click %	Setting[25] "," Setting[26] ", M"			; Креатив
	SendInput {LAlt}			; Убрать промотку после нажатия колесика
	Click, 0 90, M Rel			; Креатив 2
	SendInput {LAlt}			
	sleep 200
	Click %	Setting[27] "," Setting[28]			; Ярлык
	Click, 0 90 Rel								; Ярлык 2

	sleep 3000
	
	Loop 60 ; Цикл проверки загрузки ярлыка
		{
			WinGetActiveTitle, Title
			If RegexMatch(Title, "\w{8}-\w{4}-\w{4}-\w{4}-\w{12}", Result)
			{
			sleep 1800
			SendInput ^{vk50} ; ctrl+P
			sleep 2000
			SendInput {enter}
			sleep 500
			SendInput ^{PgDn}
			sleep 500
			SendInput {down 2}
			Click, %Center_X% %Center_Y% 0
			break
			}
			sleep 250
		}
		
	If (OrderPart[4] > 1)		; Проверка количества
		MsgBox, 262144, YANDEX, % "КОЛИЧЕСТВО: " OrderPart[4] ; ; Напоминание о количестве
}
return
} ; ========================================================= Конец YANDEX

{ ; ========================================================= WB
WB1()
{
global
loop 10 ; Чистка вкладок
{
	WinGetActiveTitle, Title

	If InStr(Title, "Поставка") or InStr(Title, "Новые")
	break

	If InStr(Title, "в интернет-магазине Wildberries") or RegexMatch(Title, "[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}", Result)
	{
		SendInput ^{vk57} ; CTRL+W Закрыть вкладку
	}

	else If !InStr(Title, "Поставка") and !InStr(Title, "Новые")
	{
		SendInput ^{PgUp} ; Предыдущая вкладка
	}
	sleep 100
}

W_Start:
Current_Line += 1

If !OrderLine[Current_Line]
{
MsgBox, 262144, WB, Конец списка
return
}

OrderPart := StrSplit(OrderLine[Current_Line], A_Tab)
If (OrderPart[3] == Old_Number) ; Проверка повтора артикула
	Goto, W_Start


sleep 100
WinGetActiveTitle, Title
If InStr(Title, "Поставка")
{
	SendInput ^{vk46}{esc} ; CTRL+F - ESC
	sleep 200
	SendInput {Home}
	sleep 250
	Click %	Setting[31] "," Setting[32] ; все галочки
	sleep 100
	Click %	Setting[31] "," Setting[32] ; все галочки
	sleep 300
	SendInput ^{vk46} ; CTRL+F
	sleep 300
	Clipboard := "Арт.: "OrderPart[3]
	SendInput ^{vk56} ; CTRL+V
}
If InStr(Title, "Новые")
{
	SendInput ^{vk46} ; CTRL+F
	sleep 100
	SendInput ^{vk56}{enter} ; CTRL+V
}
Old_Number := OrderPart[3]


AmountCheck(OrderPart[3]) ; Уведомление о количестве товаров с найденным артикулом

} ; WB1

WB2()
{
global
WinMinimize, ahk_exe AutoHotkeyU64.exe
WinGetActiveTitle, Title
If InStr(Title, "Поставка") or InStr(Title, "Новые")
{
Click, M ; Нажатие колесика для открытия креатива в фоне
SendInput {Home}
sleep 150
SendInput {Home}
sleep 150
Click %	Setting[33] "," Setting[34] ; Распечатать этикетки
sleep 100
SendInput {tab}{enter}
Loop 20 ; Цикл проверки загрузки ярлыка
{
WinGetActiveTitle, Title
If RegexMatch(Title, "[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}", Result)
	{
	sleep 2000
	SendInput ^{vk50} ; ctrl+P
	sleep 2000
	SendInput {enter}
	sleep 500
	break
	}
sleep 250
}

SendInput ^{PgDn}
Click, %Center_X% %Center_Y% 0
}
WinActivate, ahk_exe AutoHotkeyU64.exe
} ; WB2

} ; ========================================================= Конец WB

AmountCheck(Current_Number) ; Проверка количества
{
	AMOUNT_COUNT :=
	loop % OrderLine.MaxIndex()+1
	{
		Current_Line += 1
				
		If Result := StrSplit(OrderLine[Current_Line], A_Tab)
			If (Result[3] == Current_Number)
			{
				AMOUNT_COUNT += 1
			}
		else if (AMOUNT_COUNT > 1)
			{
				sleep 100
				MsgBox, 262144, WB, Найдено: %AMOUNT_COUNT%
				break
			}
		
	}
}


{ ; КОПИРОВАНИЕ В ТАБЛИЦУ
#IfWinActive

OnClipboardChange:
If WinActive("ahk_exe chrome.exe") or WinActive("ahk_exe browser.exe")
{
	If RegexMatch(Clipboard, "\d+-\d{4}-\d", Result) and InStr(Clipboard, "шт.")
	{
		global MARKETPLACE := "OZON"
		CopyOzon()
		Sorting(4)
	}
	If InStr(Clipboard, "Ваш SKU")
	{
		global MARKETPLACE := "YANDEX"
		CopyYandex()
		Sorting(2)
	}
	If InStr(Clipboard, "Ожидает отправки") and InStr(Clipboard, "ID:")
	{
		global MARKETPLACE := "ALI"
		CopyALI()
		Sorting(2)
	}
	If InStr(Clipboard, "2023") and InStr(Clipboard, "Арт.:")
	{
		global MARKETPLACE := "WB"
		CopyWB()
		Sorting(2)
	}


}
return

Sorting(WhereIsName)
{
Loop, parse, clipboard, `n, `r
	If A_LoopField
	{
		StringSplit, OrderPart, A_LoopField, %A_Tab%
		TheOrderName := OrderPart%WhereIsName%
		If (MARKETPLACE == "WB") ; Убираем название бренда
			{
			Pos := InStr(TheOrderName, "/")+1
			TheOrderName := SubStr(TheOrderName, Pos)
			}

		If InStr(TheOrderName, "час") ;============== Ищем часы
			and !InStr(TheOrderName, "Band")
			and !InStr(TheOrderName, "зарядк")
		or InStr(TheOrderName, "watch")
			and !InStr(TheOrderName, "зарядк")
			and !InStr(TheOrderName, "стекло")
			and !InStr(TheOrderName, "чехол")
		or InStr(TheOrderName, "watch")
			and InStr(TheOrderName, "не стекло")
		or InStr(TheOrderName, "Elari")
		or InStr(TheOrderName, "Polar")
		or InStr(TheOrderName, "Amazfit")
		or InStr(TheOrderName, "Huawei band")
		or InStr(TheOrderName, "Honor magic")
		or InStr(TheOrderName, "Jet sport")
		or InStr(TheOrderName, "Garmin fore")
		or InStr(TheOrderName, "Garmin viv")
		or InStr(TheOrderName, "Garmin tact")
		or InStr(TheOrderName, "Aimoto")
		or InStr(TheOrderName, "Honor band")
		or InStr(TheOrderName, "GARMIN Instinct")
		or InStr(TheOrderName, "Smarus")
		{
			If RegexMatch(TheOrderName, "i) ([a-z].*)", TheOrderNameCut) ; Обрезаем до начала названия модели
			{
				TheOrderName := "\"TheOrderNameCut1
			}
			else ;===================================== Если нет англ. букв
				TheOrderName := "\"TheOrderName
		}
		else ;==================================== Ищем остальные пленки
		If InStr(TheOrderName, "нка для") 
		or InStr(TheOrderName, "пленка")
		or InStr(TheOrderName, "плёнка")
		or InStr(TheOrderName, "ая для")
		or InStr(TheOrderName, "матов")
		or InStr(TheOrderName, "глянц")
		or InStr(TheOrderName, "нок для")
		{
			If RegexMatch(TheOrderName, "i) ([a-z].*)", TheOrderNameCut) ; Обрезаем до начала названия модели
			{
				TheOrderName := "/"TheOrderNameCut1
			}
			else ;===================================== Если нет англ. букв
			{
				TheOrderName := "/"TheOrderName
			}
		}
	
		
		OrderPart%WhereIsName% := TheOrderName ; Возвращаем переменной старое имя
		Resultstring := Resultstring OrderPart1 A_Tab OrderPart2 A_Tab OrderPart3 A_Tab OrderPart4 "`n" ; Записываем все элементы к массиву
	}
	Clipboard := Resultstring
}

CopyOzon()
{
	Loop, parse, clipboard, `n, `r
	{
		if StrAmount
		{
			if A_LoopField
				Resultstring := Resultstring A_LoopField "`n"
			StrAmount := false
		}

		If RegexMatch(A_LoopField, "\d+-\d+-\d+", Result)
		{
			Resultstring := Resultstring Result A_Tab
			Name := true
		}

		If RegexMatch(A_LoopField, "(.*), (.*) шт\.", Result)
		{
			If Name
				Resultstring := Resultstring Result1 A_Tab Result2 A_Tab
			if !Name
				Resultstring := Resultstring A_Tab Result1 A_Tab Result2 A_Tab
			StrAmount := true
			Name := false
		}
	}
	Clipboard := Resultstring
} ; Конец Озона

CopyYandex()
{
	Loop, parse, clipboard, `n, `r
		{

		If RegexMatch(A_LoopField, "\d+ \/ (.*)", Result)
		{
			Resultstring := Resultstring Result1 A_Tab
			Name := true
		}

		If RegexMatch(A_LoopField, "Ваш SKU: (.*), (.*) шт", Result) ; Новый яндекс
		{
			If Name
				Resultstring := Resultstring OldString A_Tab Result1 A_Tab Result2 "`n"
			If !Name
				Resultstring := Resultstring A_tab OldString A_Tab Result1 A_Tab Result2 "`n"

			Name := false
		}

		If RegexMatch(A_LoopField, "Ещё \d товар", Result)
		{
			MsgBox, Есть еще товар, нужно развернуть все заказы
			break
		}
		If A_LoopField
			OldString := A_LoopField
		}

	Clipboard := Resultstring
} ; Конец Яндекса


CopyWB() ; WB
{
	Loop, parse, clipboard, `n, `r
	{
		If RegexMatch(A_LoopField, "Арт.: (.*)", Result)
		{
			Resultstring := Resultstring OldString A_Tab Result1 "`n"
		}

		else If RegexMatch(A_LoopField, "\d{9}", Result)
			Resultstring := Resultstring A_LoopField A_Tab

		If A_LoopField
			OldString := A_LoopField
	}

	Clipboard := Resultstring
} ; Конец WB


CopyALI() ; ALI
{
	Loop, parse, clipboard, `n, `r
	{
		If RegexMatch(A_LoopField, "\d{16}", Result)
		and RegexMatch(OldString, "\d{8}", Result)
		{
			Resultstring := Resultstring OldString A_Tab
		}
		
		If (A_LoopField == "Ожидает отправки")
			COUNT := 3
		
		If (COUNT == 2)
			Resultstring := Resultstring A_LoopField A_Tab
		
		If (COUNT == 1)
			Resultstring := Resultstring A_LoopField A_Tab
		
		else If RegexMatch(A_LoopField, "ID: (.*)", Result)
			Resultstring := Resultstring result1 A_Tab 

		If A_LoopField
		{
			OldString := A_LoopField
			COUNT -= 1
		}
	}
	Clipboard := Resultstring
} ; Конец ALI


} ; Копирование в таблицы
